"""
ME RIGHT NOW üëá

¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥ ¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥`
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥`¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥`
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬∂¬∂¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬∂¬∂¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬¥¬¥¬¥
¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬∂¬∂¬∂¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥
¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬∂¬∂¬¥¬¥
¬¥¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬¥
¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂
¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂
¬¥¬¥¬∂¬∂¬∂¬∂¬¥¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬∂¬∂¬∂¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬∂¬∂¬∂¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬∂¬∂¬∂¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬∂¬∂¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬∂¬∂¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬∂¬∂¬¥¬∂¬¥¬∂¬¥¬∂¬¥¬∂¬¥¬∂¬¥¬∂¬¥¬∂¬¥¬∂¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬¥¬¥¬∂¬¥¬∂¬¥¬∂¬¥¬∂¬¥¬∂¬¥¬∂¬¥¬∂¬¥¬∂¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬¥¬∂¬∂¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬∂¬∂¬¥¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬¥¬¥¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥
¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬¥¬∂¬∂¬∂¬∂¬¥¬¥¬¥¬¥¬¥¬¥¬¥
"""

import json
import random
import time
from datetime import datetime
import requests
from aiogram import types
from aiogram.utils.exceptions import BotBlocked, MessageError
from aiogram.utils.markdown import bold, text
from bson import ObjectId

from common import (
    delete_keyboard,
    get_options,
    today_is_the_day,
    utc_date_is_the_day,
    get_pictures,
    rand_select_obj_texts,
    Weekdays,
    n_days_since_date,
    any_ratings_in_previous_n_days
)
from keyboards import (
    kb_for_mental_poll,
    support_start_keyboard,
    ask_for_rate_messages
)
from volunteers import is_mental_rate_threashhold_reached, how_many_days_user_with_us
from variables import (
    CONTENTFUL_API_READONLY_URL,
    CONTENTFUL_SPACE_ID,
    CONTENTFUL_ACCESS_TOKEN,
    LINK_TO_FORM,
    botClient
)
from ratestata import send_rate_stata
from friends import send_a_friend_message_about_bad_mood
from db.users import (
    get_user_by_telegram_id,
    update_user_is_active
)
from db.mental_rate import (
    get_unrated_mental_rate,
    get_mental_rate_by_user_and_tg_message,
    insert_new_mental_rate,
    update_mental_rate_value
)
from db.messages import (
    get_message_to_send_to_user
)
from db.user_messages import (
    insert_new_user_message,
    get_latest_message_by_user
)
from db.rate import (
    get_rate_by_user_and_message
)


# read texts from json file
with open('texts.json', encoding="utf-8") as t:
    texts = json.load(t)


async def sendmes(chat_id: int):
    """
    Message handler for /sendmes command

    Parameters:
    chat_id (int): Telegram ID of user to send message

    Returns:
    None
    """

    try:
        user = get_user_by_telegram_id(str(chat_id))
        prev_unrated_message = get_unrated_mental_rate(user["_id"])

        if prev_unrated_message:
            await delete_keyboard(chat_id, prev_unrated_message['id_tg_message'])

        message = await botClient.send_message(
            chat_id,
            get_options('polls_questions'),
            parse_mode=types.ParseMode.MARKDOWN,
            reply_markup=kb_for_mental_poll
        )
        insert_new_mental_rate(
            user['_id'],
            0,
            message.message_id
        )

    except BotBlocked:
        print(f"–Æ–∑–µ—Ä {chat_id} –ø–∏–¥–æ—Ä, –∑–∞–±–ª–æ—á–∏–ª –±–æ—Ç–∞")
        update_user_is_active(user['_id'], False)

    except MessageError:
        await botClient.send_message(
            chat_id,
            (
                "–û–π, –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ üòû \n"
                "–ü–æ–≤—Ç–æ—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∏–ª–∏ "
                "–Ω–∞–ø–∏—à–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /feedback"
            )
        )


async def callback_after_click_on_color_button(
    callback_query: types.CallbackQuery,
    rate: int,
    color: str
):
    """
    Callback handler for /sendmes

    Parameters:
    callback_query (TG Callback): callback to handle, can be
        "green_button_answer"
        "yellow_button_answer"
        "orange_button_answer"
        "red_button_answer"
    rate (int): rate of mental state, from 1 to 4 (red to green)
    color (str): color of mental state, can be:
        "green"
        "yellow"
        "orange"
        "red"

    Returns:
    None
    """

    await botClient.answer_callback_query(callback_query.id)
    await delete_keyboard(callback_query.from_user.id, callback_query.message.message_id)

    try:
        # –¥–æ–±–∞–≤–∏–ª –¥–≤–µ —Å—Ç—Ä–æ–∫–∏ –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ –∫–æ–ª–ª–±–µ–∫—É —Å—Ç–∏—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ–±—â–µ–Ω–∏—è —Å —á–∞—Ç–∂–ø—Ç,
        #   —á—Ç–æ–±—ã –æ–Ω –Ω–µ –∫–æ–ø–∏–ª—Å—è
        # UPD: –Ω–µ –¥–æ–±–∞–≤–∏–ª( –Ω–∞–¥–æ –Ω–∞–ø–∏—Å–∞—Ç—å —á–µ—Ç–æ,
        #   —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ–±—â–µ–Ω–∏—è —Å —á–∞—Ç–∂–ø—Ç –Ω–µ –¥–µ—Ä–∂–∞–ª—Å—è –≤ –ø–∞–º—è—Ç–∏, –∞ –¥—Ä–æ–ø–∞–ª—Å—è –ø–æ –∫—Ä–æ–Ω—É –≤ –ø–æ–ª–Ω–æ—á—å :(
        #   —Å–æ—Ä—Ä–∏ –ø–∞—Ü–∞–Ω—ã
        # if array_of_chats != None:
        #    array_of_chats.delete_array(callback_query.from_user.id)
        #    array_of_chats.add_message(
        #        callback_query.from_user.id,
        #        {
        #            'role': 'assistant',
        #            'content': (
        #                "–û—Ç–≤–µ—á–∞–π –æ—Ç –∏–º–µ–Ω–∏ –†–æ–¥–∂–µ—Ä–∞. –≠—Ç–æ –±–æ—Ç, "
        #                "–∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª—é–¥–µ–π —Å –ø–ª–æ—Ö–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º"
        #            )
        #         }
        #     )

        user = get_user_by_telegram_id(str(callback_query.from_user.id))

        # find_one_and_update returns a record that is to be updated;
        #   in this case it is irrelevant whether
        # we receive the updated version of the record or not, since we're only
        # interested in the date

        rate_record = get_mental_rate_by_user_and_tg_message(
            user["_id"],
            callback_query.message.message_id
        )
        update_mental_rate_value(rate_record['_id'], rate)

        await get_options_color(color, callback_query.from_user.id)
        await row_message(callback_query.from_user.id)
        await is_mental_rate_threashhold_reached(callback_query.from_user.id, 'volunteer')

        if rate_record is not None:
            if need_send_weekly_rate_stata(
                    int(user['timezone']), user['created_at'], user['_id'], rate_record['date']):
                await sunday_send_rate_stata(callback_query.from_user.id, rate_record['date'])

        # –æ—Ç–∫–ª—é—á–∏–ª —á–∞—Ç–∂–ø—Ç –≤ –∫–æ–ª–±–µ–∫–∞—Ö
        # await offer_to_chat_with_chatgpt(color, callback_query.from_user.id)
        if color in ('red', 'orange'):
            await send_a_friend_message_about_bad_mood(callback_query.from_user.id, color)

    except MessageError:
        await botClient.send_message(
            callback_query.from_user.id,
            (
                "–û–π, –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ üòû \n"
                "–ù–∞–ø–∏—à–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /feedback, "
                "–æ–Ω–∏ –ø–æ–º–æ–≥—É—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –ø—Ä–æ–±–ª–µ–º–æ–π üëå"
            )
        )


async def create_message_with_support(
    user: dict,
    message_to_send: dict
):
    """
    Function to create message with support images/videos/gifs

    Parameters:
    user (dict): User dict from DB
    message_to_send: (dict): message to send to user, dict from DB

    Returns:
    None
    """

    chat_id = user["telegram_id"]
    message = ""

    if message_to_send['is_anonymous']:
        message = text(bold("–ò–º—è: ") + "–ê–Ω–æ–Ω–∏–º" + '\n')
    else:
        message = text(
            bold("–ò–º—è: ") +
            message_to_send["user"][0]["name"] +
            '\n')

    if len(message_to_send['image_ids']) > 0:
        message = message + '\n' + text(bold('–í–ª–æ–∂–µ–Ω–∏—è:'))

        await botClient.send_message(chat_id, message, parse_mode=types.ParseMode.MARKDOWN)

        message = ""
        media = types.MediaGroup()

        for i in message_to_send['image_ids']:
            picture_url = await get_pictures(i)
            if '.gif' in picture_url:
                # –ü—Ä–æ–±–æ–≤–∞–ª attach_video —Ç—É—Ç, –Ω–æ –ø–æ—á–µ–º—É-—Ç–æ –∫—Ä–∞—à–∏—Ç—Å—è
                media.attach_photo(picture_url)
            else:
                media.attach_photo(picture_url + '?fm=jpg')

        await botClient.send_media_group(chat_id, media=media)
    else:
        message = message + '\n'

    # —Ç–µ–ª–µ–≥–∞ –Ω–µ –ø—É—Å–∫–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å —ç—Ç–∏–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏, —Å–¥–µ–ª–∞–ª–∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    # –≤–º–µ—Å—Ç–µ ü§ù
    message_to_send['text'] = message_to_send['text'].replace("_", "\\_")
    message_to_send['text'] = message_to_send['text'].replace("*", "\\*")
    message_to_send['text'] = message_to_send['text'].replace("`", "\\`")
    message_to_send['text'] = message_to_send['text'].replace("[", "\\[")

    message = message + text(bold("–°–æ–æ–±—â–µ–Ω–∏–µ: ") +
                             '\n' + message_to_send['text'] + '\n')
    message = message + '\n'
    if message_to_send['media_link'] != "":
        message = message + \
            text(
                bold("–ß—Ç–æ —Å—Ç–æ–∏—Ç –≥–ª—è–Ω—É—Ç—å: ") +
                '\n' +
                message_to_send['media_link'])
    try:
        prev_message = get_latest_message_by_user(user["_id"])

        if prev_message is not None:
            rate_previous_mes = get_rate_by_user_and_message(
                user["_id"], prev_message['id_message'])

            if rate_previous_mes is None:
                await delete_keyboard(chat_id, prev_message['id_tg_message'])

        id_message = await botClient.send_message(
            chat_id,
            message,
            parse_mode=types.ParseMode.MARKDOWN,
            disable_web_page_preview=True,
            reply_markup=ask_for_rate_messages
        )

        print("\n")
        print('USER_MESSAGES -> —Ç—ã —É–≤–∏–¥–µ–ª —Å–æ–æ–±—â–µ–Ω–∏–µ')
        print(
            {
                "id_user": user['_id'],
                "id_message": message_to_send["_id"],
                "time_to_send": datetime.now(),
                "id_tg_message": id_message.message_id
            }
        )

        insert_new_user_message(
            user["_id"],
            message_to_send["_id"],
            id_message.message_id
        )
    except MessageError:
        await botClient.send_message(
            chat_id,
            (
                "–û–π, –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ üòû \n"
                "–ù–∞–ø–∏—à–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /feedback, "
                "–æ–Ω–∏ –ø–æ–º–æ–≥—É—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –ø—Ä–æ–±–ª–µ–º–æ–π üëå"
            )
        )


async def get_cat_gif():
    """
    Function to get a random support gif URL

    Parameters:

    Returns:
    str
    """

    response = requests.get(
        CONTENTFUL_API_READONLY_URL + 'spaces/' +
        CONTENTFUL_SPACE_ID + '/environments/master/assets?access_token=' +
        CONTENTFUL_ACCESS_TOKEN + '&metadata.tags.sys.id[all]=catGifs',
        timeout=10
    )
    all_gifs = json.loads(response.content).get("items")

    random_gif = all_gifs[random.randint(0, len(all_gifs) - 1)]
    gif_link = str(random_gif.get("fields").get("file").get("url")[2:])

    print(gif_link)

    return gif_link


async def get_video_when_no_messages():
    """
    Function to get a support random video URL

    Parameters:

    Returns:
    str
    """

    response = requests.get(
        CONTENTFUL_API_READONLY_URL + 'spaces/' +
        CONTENTFUL_SPACE_ID + '/environments/master/assets?access_token=' +
        CONTENTFUL_ACCESS_TOKEN +
        '&metadata.tags.sys.id[all]=videoToSendWhenNoMessages',
        timeout=10
    )

    all_videos = json.loads(response.content).get("items")

    random_video = all_videos[random.randint(0, len(all_videos) - 1)]
    video_link = str(random_video.get("fields").get("file").get("url")[2:])

    return video_link


async def get_options_color(color: str, chat_id: int):
    """
    Function get text for a mood color

    Parameters:
    color (str): color of mental state, can be:
        "green"
        "yellow"
        "orange"
        "red"
    chat_id (int): Telegram ID of user to send a message

    Returns:
    None
    """

    arr = []
    for item in texts.get("polls_answers"):
        if item["color"] == color:
            arr = item["answers_arrays"]
    await get_texts_to_send_mood(arr, chat_id)


async def get_texts_to_send_mood(arr: list, chat_id: int):
    """
    Function to create a support message from text format

    Parameters:
    arr (list): message "polls_answers" from texts.json
    chat_id (int): Telegram ID of user to send a message

    Returns:
    None
    """

    for item in arr:
        if (item[0] == '*'):
            if item == '*gif*':
                await botClient.send_video(chat_id, await get_cat_gif())

            if item == '*support*':
                user = get_user_by_telegram_id(str(chat_id))

                print("\n")
                print("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∫–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ")
                print(user["_id"])

                message_to_send = get_message_to_send_to_user(user['_id'])

                print("\n")
                print("–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–∫–∞–∑–∞")
                print(message_to_send)

                if len(message_to_send) != 0:
                    await create_message_with_support(user, message_to_send[0])
                else:
                    await botClient.send_message(
                        chat_id,
                        (
                            "–ò–∑–≤–∏–Ω–∏, —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å üòû \n"
                            "–í–æ—Ç –≤–∏–¥–µ–æ –æ—Ç –º–µ–Ω—è, –æ–Ω–æ —Ç–æ—á–Ω–æ –ø–æ–º–æ–∂–µ—Ç:"
                        )
                    )
                    await botClient.send_video(chat_id, await get_video_when_no_messages())

            if item == '*waiting_day_feedback*':
                print("–ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏")
                # –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ <- –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç—É—Ç??!
                # –ø–æ–∫–∞ –Ω–∏—á–µ) 
            if item == "*wait_for_answer_to_form*":
                s = rand_select_obj_texts(texts.get('invite_to_form'))
                user = get_user_by_telegram_id(str(chat_id))
                await botClient.send_message(
                    chat_id,
                    s.get('text') + '\n' + LINK_TO_FORM + str(user['form_id']),
                    disable_web_page_preview=True
                )
        else:
            s = rand_select_obj_texts(texts.get(item))
            await botClient.send_message(chat_id, s.get('text'))
            time.sleep(1)


async def row_message(chat_id: int):
    """
    Function to show number of total mental rates

    Parameters:
    chat_id (int): Telegram ID of user to send a message

    Returns:
    None
    """

    await botClient.send_message(
        chat_id,
        (
            "–¢—ã —É–∂–µ –∑–∞–º–µ—Ä–∏–ª —Å–≤–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ " + str(how_many_days_user_with_us(chat_id)) +
            " —Ä–∞–∑! –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ üòé"
        )
    )


async def offer_to_chat_with_chatgpt(color: str, user_id: int):
    """
    Function to offer to use ChatGPT

    Parameters:
    color (int): color of mental rate, can be:
        "green"
        "yellow"
        "orange"
        "red"
    user_id (int): Telegram ID of user to send a message

    Returns:
    None
    """

    if color in ['red', 'orange']:
        await botClient.send_message(
            user_id,
            (
                "–ö–∞–∫ –Ω–∞—Å—á–µ—Ç –ø–æ–±–æ–ª—Ç–∞—Ç—å —Å–æ –º–Ω–æ–π? –Ø –º–æ–≥—É –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –¥–∏–∞–ª–æ–≥: "
                "—É–º–µ—é —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –∏ –¥–∞–≤–∞—Ç—å –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã. –ü–æ–ø—Ä–æ–±—É–µ–º?"
            ),
            reply_markup=support_start_keyboard
        )


def need_send_weekly_rate_stata(
    timezone_offset: int,
    created_at: datetime,
    id_user: ObjectId,
    rate_date: datetime
) -> bool:
    """
    Function, that is used to check whether we should display weekly stata to a user
        after they rated their mood

    Parameters:
    timezone_offset (int): user's timezone offset
    created_at (datetime): date at which this particular user was created
    id_user (ObjectId): Telegram ID of user to send a message
    rate_date (datetime): date at which the currently handled rate message was sent

    Returns:
    bool
    """

    try:
        today_is_monday_or_sunday = today_is_the_day(Weekdays.SUNDAY, timezone_offset) or \
            today_is_the_day(Weekdays.MONDAY, timezone_offset)
        rate_date_is_sunday = utc_date_is_the_day(
            rate_date, Weekdays.SUNDAY, timezone_offset)
        return \
            rate_date_is_sunday and \
            today_is_monday_or_sunday and \
            n_days_since_date(3, created_at) and \
            any_ratings_in_previous_n_days(id_user, 6)
    except MessageError as e:
        print(f'need_send_weekly_rate_stata failed check, exception: {e}')
        return False


async def sunday_send_rate_stata(chat_id: int, rate_date: datetime):
    """
    A non-destructive modification of send_rate stata
        for the purposes of sending weekly stata after a user
        has rated their mood on a Sunday.
    Sends a message from a collection of specially manufactured texts and then
        sends mental state statistics for the past week.

    Parameters:
    chat_id (int): Telegram ID of user to send a message
    rate_date (datetime): date at which the currently handled rate message was sent

    Returns:
    None
    """

    mes = rand_select_obj_texts(texts.get('mental_week_stata'))
    await botClient.send_message(chat_id, mes['text'])
    # as mentioned before, rate date is in UTC+00 timezone,
    # but send_rate_stata expects a function that takes a
    # pytz.BaseTzInfo instance as its single parameter
    await send_rate_stata(str(chat_id), 'week', lambda ptz_utc: rate_date)
